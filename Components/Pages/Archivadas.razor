@page "/archivadas"
@rendermode InteractiveServer
@using blazor.Components.Data
@using blazor.Components.Servicios
@inject blazor.Components.Servicios.ServicioControlador ServicioControlador
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<PageTitle>Facturas Archivadas (Acceso Restringido)</PageTitle>

<div class="facturapro-bg min-h-screen">
    <div class="facturapro-card">

        <h1 class="fp-title" style="margin-bottom: 0;">
            <span class="fp-primary-color">📦 Facturas Archivadas</span>
        </h1>
        <hr />

        @if (AccesoPermitido)
        {
            @if (FacturasArchivadas.Any())
            {
                <p class="text-lg mb-4" style="color: var(--fp-on-surface-variant);">
                    Estas facturas están archivadas y excluidas de reportes.
                </p>

                <table class="table table-hover table-striped table-facturapro">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th class="text-end">Total</th>
                            <th style="width: 150px;">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var factura in FacturasArchivadas)
                        {
                            <tr>
                                <td>@factura.Id</td>
                                <td>@factura.FechaFactura.ToShortDateString()</td>
                                <td>@factura.NombreCliente</td>
                                <td class="text-end">$@factura.Total.ToString("N2")</td>
                                <td class="d-flex justify-content-center">
                                    <button class="btn btn-sm fp-action-primary" @onclick="() => Desarchivar(factura.Id)" style="background-color: var(--fp-tertiary); color: white;">
                                        ↩️ Desarchivar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="alert alert-info" style="background-color: var(--fp-surface); color: var(--fp-primary); border-color: var(--fp-primary);">
                    No hay facturas archivadas.
                </div>
            }
        }
        else
        {
            <div class="d-flex flex-column align-items-center p-5 border rounded-3" style="border-color: var(--fp-primary-border); max-width: 400px; margin: 30px auto;">
                <h3 class="mb-4" style="color: var(--fp-secondary);">Ingresar PIN de Acceso</h3>

                <div class="input-group mb-3">
                    <InputText @bind-Value="PinIngresado"
                               type="password"
                               maxlength="4"
                               placeholder="PIN de 4 dígitos"
                               class="form-control form-control-lg text-center"
                               @onkeydown="ManejarTeclaEnter"
                               style="border-color: var(--fp-primary-border); font-size: 1.5rem;" />
                    <button class="btn fp-button-elevated" @onclick="VerificarAcceso" style="background-color: var(--fp-secondary); color: white;">
                        🔑
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(MensajeError))
                {
                    <p class="text-danger mt-2">@MensajeError</p>
                }
            </div>
        }
    </div>
</div>

<div class="fab-container">
    <button class="fp-fab-secondary" @onclick="VolverAVista">
        🏠
    </button>
</div>

@code {
    private const string PIN_SECRETO = "3029";
    private bool AccesoPermitido { get; set; } = false;
    private string PinIngresado { get; set; } = string.Empty;
    private string MensajeError { get; set; } = string.Empty;
    private IEnumerable<Factura> FacturasArchivadas { get; set; } = new List<Factura>();

    protected override async Task OnInitializedAsync()
    {
    }

    private async Task VerificarAcceso()
    {
        if (PinIngresado == PIN_SECRETO)
        {
            AccesoPermitido = true;
            MensajeError = string.Empty;
            await CargarArchivadas(); 
        }
        else
        {
            MensajeError = "PIN incorrecto. Vuelve a intentarlo.";
            PinIngresado = string.Empty;
        }
    }

    private void ManejarTeclaEnter(Microsoft.AspNetCore.Components.Web.KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _ = VerificarAcceso();
        }
    }

    private async Task CargarArchivadas()
    {
        FacturasArchivadas = await ServicioControlador.ObtenerFacturasArchivadasAsync();
    }

    private async Task Desarchivar(int facturaId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Está seguro de desarchivar la Factura # {facturaId}? Volverá a aparecer en los listados principales.");

        if (confirmed)
        {
            try
            {
                await ServicioControlador.DesarchivarFacturaAsync(facturaId);
                await CargarArchivadas(); 
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al desarchivar la factura: {ex.Message}");
            }
        }
    }

    private void VolverAVista()
    {
        Navigation.NavigateTo("/Vista");
    }
}