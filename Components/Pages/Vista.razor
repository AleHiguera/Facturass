@page "/Vista"
@rendermode InteractiveServer
@using blazor.Components.Data
@using blazor.Components.Servicios
@inject blazor.Components.Servicios.ServicioControlador ServicioControlador
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<div class="facturapro-bg">
    <div class="facturapro-card">

        <div class="d-flex justify-content-start align-items-center mb-3">
            <h1 class="fp-title" style="margin-bottom: 0;">
                <span class="fp-primary-color">🧾 FacturaPro</span> - Facturas Registradas
            </h1>
        </div>

        <hr />

        <div class="row mb-3">
            <div class="col-12 col-md-7">
                <div class="input-group">
                    <input @bind="ServicioControlador.FiltroNombreCliente"
                           @bind:event="oninput"
                           placeholder="Filtrar por Nombre de Cliente..."
                           class="form-control" />

                    <button class="btn fp-text-icon-button" @onclick="BorrarFiltroNombre">
                        ❌
                    </button>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 col-md-5 d-flex justify-content-end ms-auto">
                <div class="input-group" style="max-width: 300px;">
                    <label class="input-group-text input-group-text-fp">
                        Ordenar:
                    </label>
                    <select @bind="OrdenacionAuxiliar"
                            class="form-select">
                        @foreach (var criterio in Enum.GetValues<CriterioOrdenacion>())
                        {
                            <option value="@criterio">
                                @ObtenerTextoCriterio(criterio)
                            </option>
                        }
                    </select>
                </div>
            </div>
        </div>
        <hr />

        @if (FacturasFiltradas.Any())
        {
            <table class="table table-hover table-striped table-facturapro">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th class="text-end">Artículos</th>
                        <th class="text-end">Total</th>
                        <th style="width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var factura in FacturasFiltradas)
                    {
                        <tr style="cursor: pointer;">
                            <td @onclick="() => VerDetalle(factura.Id)">@factura.Id</td>
                            <td @onclick="() => VerDetalle(factura.Id)">@factura.FechaFactura.ToShortDateString()</td>
                            <td @onclick="() => VerDetalle(factura.Id)">@factura.NombreCliente</td>
                            <td @onclick="() => VerDetalle(factura.Id)" class="text-end">@factura.Articulos.Count</td>
                            <td @onclick="() => VerDetalle(factura.Id)" class="text-end">$@factura.Total.ToString("N2")</td>

                            <td class="d-flex justify-content-center gap-2">
                                <button class="btn btn-sm fp-action-edit" @onclick="() => EditarFactura(factura.Id)">
                                    ✏️
                                </button>
                                <button class="btn btn-sm fp-action-delete" @onclick="() => ConfirmarEliminar(factura.Id)">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-warning" style="background-color: var(--fp-surface); color: var(--fp-primary); border-color: var(--fp-primary);">
                No se encontraron facturas que coincidan con el filtro.
            </div>
        }
    </div>
</div>

<div class="fab-container">

    <button class="fp-fab-secondary" @onclick="IrADashboard">
        📋
    </button>

    <button class="fp-fab-secondary" @onclick="IrAReporteSAT">
        📊
    </button>

    <button class="fp-fab-secondary" @onclick="RegresarAlInicio">
        🏠
    </button>

    <button class="fp-efab" @onclick="CrearNuevaFactura">
        <i class="oi oi-plus"></i> Crear Nueva Factura
    </button>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await ServicioControlador.CargarFiltroAsync();
        await ServicioControlador.CargarFacturasAsync();
    }

    private IEnumerable<Factura> FacturasFiltradas => ServicioControlador.ObtenerFacturasFiltradas();
    private CriterioOrdenacion OrdenacionAuxiliar
    {
        get => ServicioControlador.OrdenacionSeleccionada;
        set
        {
            if (ServicioControlador.OrdenacionSeleccionada != value)
            {
                ServicioControlador.OrdenacionSeleccionada = value;
                StateHasChanged();
            }
        }
    }

    private string ObtenerTextoCriterio(CriterioOrdenacion criterio)
    {
        return criterio switch
        {
            CriterioOrdenacion.FechaDescendente => "Fecha (Más Reciente)",
            CriterioOrdenacion.IdDescendente => "ID (Más Alto)",
            CriterioOrdenacion.NombreClienteAscendente => "Cliente (A-Z)",
            _ => criterio.ToString()
        };
    }

    private void BorrarFiltroNombre()
    {
        ServicioControlador.FiltroNombreCliente = string.Empty;
        StateHasChanged();
    }

    private void VerDetalle(int facturaId)
    {
        Navigation.NavigateTo($"/detalle-factura/{facturaId}");
    }

    private void RegresarAlInicio()
    {
        Navigation.NavigateTo("/");
    }

    private void CrearNuevaFactura()
    {
        Navigation.NavigateTo("/nueva-factura");
    }

    private void IrAReporteSAT()
    {
        Navigation.NavigateTo("/reporte-sat");
    }

    private void IrADashboard()
    {
        Navigation.NavigateTo("/dashboard");
    }

    private void EditarFactura(int facturaId)
    {
        Navigation.NavigateTo($"/editar-factura/{facturaId}");
    }

    private async Task ConfirmarEliminar(int facturaId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Está seguro de eliminar la Factura # {facturaId} y todos sus artículos?");

        if (confirmed)
        {
            try
            {
                await ServicioControlador.EliminarFacturaAsync(facturaId);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al eliminar la factura: {ex.Message}");
            }
        }
    }
}