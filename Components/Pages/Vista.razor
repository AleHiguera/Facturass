@page "/Vista"
@rendermode InteractiveServer
@using blazor.Components.Data
@using blazor.Components.Servicios
@inject blazor.Components.Servicios.ServicioControlador ServicioControlador
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JSRuntime

<h3>📄 Facturas Registradas</h3>
<hr />

<div class="row mb-3 align-items-center">
    <div class="col-md-6">
        <div class="input-group">
            <input @bind="ServicioControlador.FiltroNombreCliente"
                   @bind:event="oninput"
                   placeholder="Filtrar por Nombre de Cliente..."
                   class="form-control" />

            <button class="btn btn-outline-secondary" @onclick="BorrarFiltroNombre">
                ❌ Borrar Filtro
            </button>
        </div>
    </div>

    <div class="col-md-6 d-flex justify-content-end">
        <div class="input-group" style="max-width: 300px;">
            <label class="input-group-text">Ordenar por:</label>
            <select @bind="ServicioControlador.OrdenacionSeleccionada"
                    class="form-select">
                @foreach (var criterio in Enum.GetValues<CriterioOrdenacion>())
                {
                    <option value="@criterio">
                        @ObtenerTextoCriterio(criterio)
                    </option>
                }
            </select>
        </div>
    </div>
</div>

<hr />

<p>
    <button class="btn btn-primary" @onclick="CrearNuevaFactura">
        ➕ Crear Nueva Factura
    </button>
</p>

@if (FacturasFiltradas.Any())
{
    <table class="table table-hover table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th class="text-end">Artículos</th>
                <th class="text-end">Total</th>
                <th style="width: 100px;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var factura in FacturasFiltradas)
            {
                <tr style="cursor: pointer;">
                    <td @onclick="() => VerDetalle(factura.Id)">@factura.Id</td>
                    <td @onclick="() => VerDetalle(factura.Id)">@factura.FechaFactura.ToShortDateString()</td>
                    <td @onclick="() => VerDetalle(factura.Id)">@factura.NombreCliente</td>
                    <td @onclick="() => VerDetalle(factura.Id)" class="text-end">@factura.Articulos.Count</td>
                    <td @onclick="() => VerDetalle(factura.Id)" class="text-end">$@factura.Total.ToString("N2")</td>
                    <td class="d-flex justify-content-center gap-1">
                        <button class="btn btn-sm btn-info" @onclick="() => EditarFactura(factura.Id)">
                            ✏️
                        </button>
                        <button class="btn btn-sm btn-danger" @onclick="() => ConfirmarEliminar(factura.Id)">
                            🗑️
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div class="alert alert-warning">
        No se encontraron facturas que coincidan con el filtro.
    </div>
}

@code {
    protected override async Task OnInitializedAsync()
    {
        await ServicioControlador.CargarFiltroAsync();
        await ServicioControlador.CargarFacturasAsync();
    }

    private IEnumerable<Factura> FacturasFiltradas => ServicioControlador.ObtenerFacturasFiltradas();

    private string ObtenerTextoCriterio(CriterioOrdenacion criterio)
    {
        return criterio switch
        {
            CriterioOrdenacion.FechaDescendente => "Fecha (Más Reciente)",
            CriterioOrdenacion.IdDescendente => "ID (Más Alto)",
            CriterioOrdenacion.NombreClienteAscendente => "Cliente (A-Z)",
            _ => criterio.ToString()
        };
    }

    private void BorrarFiltroNombre()
    {
        ServicioControlador.FiltroNombreCliente = string.Empty;
        StateHasChanged();
    }

    private void VerDetalle(int facturaId)
    {
        Navigation.NavigateTo($"/detalle-factura/{facturaId}");
    }

    private void CrearNuevaFactura()
    {
        Navigation.NavigateTo("/nueva-factura");
    }

    private void EditarFactura(int facturaId)
    {
        Navigation.NavigateTo($"/editar-factura/{facturaId}");
    }

    private async Task ConfirmarEliminar(int facturaId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Está seguro de eliminar la Factura # {facturaId} y todos sus artículos?");

        if (confirmed)
        {
            try
            {
                await ServicioControlador.EliminarFacturaAsync(facturaId);
                StateHasChanged(); 
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al eliminar la factura: {ex.Message}");
            }
        }
    }
}