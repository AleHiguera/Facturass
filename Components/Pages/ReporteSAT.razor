@page "/reporte-sat"
@rendermode InteractiveServer
@using blazor.Components.Data
@using blazor.Components.Servicios
@inject blazor.Components.Servicios.ServicioControlador ServicioControlador
@inject NavigationManager Navigation

<PageTitle>Reporte SAT Anual</PageTitle>

<div class="facturapro-bg min-h-screen p-4 sm:p-8 flex justify-center">
    <div class="fp-page-container w-full max-w-4xl p-6 md:p-8">

        <h1 class="text-4xl font-extrabold mb-2" style="color: var(--fp-primary);">
            <i class="oi oi-bar-chart" style="font-size: 1.5rem; margin-right: 10px; color: var(--fp-secondary);"></i>
            <span class="fp-primary-color">Reporte SAT Anual</span>
        </h1>
        <p class="text-lg mb-4" style="color: var(--fp-on-surface-variant);">
            Selecciona el año para generar el resumen mensual de facturas.
        </p>

        <hr style="border-top: 2px solid var(--fp-primary-border);" class="mb-6" />

        <div class="bg-white p-6 rounded-xl facturapro-card-shadow border" style="border-color: var(--fp-primary-border);">

            <div class="flex flex-col md:flex-row mb-6 items-start md:items-center gap-4">
                <div class="w-full md:w-1/3">
                    <label for="selectAnio" class="form-label font-semibold block mb-1" style="color: var(--fp-on-surface);">Seleccionar Año</label>
                    <InputSelect @bind-Value="AnioSeleccionadoString"
                                 class="fp-input"
                                 id="selectAnio">
                        @foreach (var anio in AñosDisponibles)
                        {
                            <option value="@anio">@anio</option>
                        }
                    </InputSelect>
                </div>
                <div class="md:pt-6">
                    @if (Cargando)
                    {
                        <p class="font-semibold" style="color: var(--fp-secondary);">Cargando datos...</p>
                    }
                </div>
            </div>

            @if (Reporte.Any())
            {
                <h5 class="text-xl font-semibold mb-3" style="color: var(--fp-primary);">Resumen del Año @AnioSeleccionadoString</h5>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse" style="border: 1px solid var(--fp-primary-border);">
                        <thead style="background-color: var(--fp-primary); color: white;">
                            <tr class="text-sm uppercase font-semibold tracking-wider">
                                <th class="p-3 border-b-2" style="border-bottom-color: var(--fp-secondary);">Mes</th>
                                <th class="p-3 border-b-2 text-center" style="border-bottom-color: var(--fp-secondary);">Facturas Emitidas</th>
                                <th class="p-3 border-b-2 text-end" style="border-bottom-color: var(--fp-secondary);">Total Facturado (@MonedaReporte)</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var mes in Reporte)
                            {
                                <tr class="hover:bg-gray-50 transition duration-150" style="background-color: @(mes.MesNumero % 2 != 0 ? "white" : "var(--fp-surface-alt)"); color: var(--fp-on-surface-variant);">
                                    <td class="p-3 border-b font-semibold" style="border-color: var(--fp-primary-border);">@mes.NombreMes.ToUpper()</td>
                                    <td class="p-3 border-b text-center" style="border-color: var(--fp-primary-border);">@mes.CantidadFacturas</td>
                                    <td class="p-3 border-b text-end font-bold" style="border-color: var(--fp-primary-border); color: var(--fp-secondary);">
                                        @mes.TotalMes.ToString("C2")
                                    </td>
                                </tr>
                            }
                        </tbody>

                        <tfoot style="background-color: var(--fp-tertiary); color: var(--fp-on-tertiary); font-size: 1.2rem; font-weight: 700;">
                            <tr>
                                <th class="p-3" style="color: black;">TOTAL ANUAL</th>
                                <th class="p-3 text-center">@Reporte.Sum(r => r.CantidadFacturas)</th>
                                <th class="p-3 text-end">@Reporte.Sum(r => r.TotalMes).ToString("C2")</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            
            }
            else if (!Cargando)
            {
                <div class="p-4 rounded-xl shadow-sm" style="background-color: var(--fp-secondary-soft); color: var(--fp-on-secondary-soft); border: 1px solid var(--fp-secondary);">
                    <p class="font-bold">
                        <i class="oi oi-warning"></i> No se encontraron facturas registradas para el año **@_anioSeleccionado**.
                    </p>
                </div>
            }
        </div>

    </div>
</div>

<div class="fab-container">
    <button class="fp-efab" @onclick="VolverAFacturas">
        <i class="oi oi-list"></i> Volver a Facturas
    </button>
</div>

@code {
    private List<int> AñosDisponibles = Enumerable.Range(DateTime.Now.Year - 5, 6).OrderByDescending(a => a).ToList();

    private int _anioSeleccionado = DateTime.Now.Year;

    private const string MonedaReporte = "MXN";
    private IEnumerable<Factura.ReporteMensual> Reporte = new List<Factura.ReporteMensual>();
    private bool Cargando = true;

    private string AnioSeleccionadoString
    {
        get => _anioSeleccionado.ToString();
        set
        {
            if (int.TryParse(value, out int nuevoAnio))
            {
                if (_anioSeleccionado != nuevoAnio)
                {
                    _anioSeleccionado = nuevoAnio;
                    _ = CargarReporte();
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {

        var todasLasFacturas = await ServicioControlador.ObtenerTodasFacturasAsync();
        if (todasLasFacturas.Any())
        {
            int minAnio = todasLasFacturas.Min(f => f.FechaFactura.Year);
            int maxAnio = todasLasFacturas.Max(f => f.FechaFactura.Year);
            AñosDisponibles = Enumerable.Range(minAnio, maxAnio - minAnio + 1).OrderByDescending(a => a).ToList();

            _anioSeleccionado = maxAnio;
        }

        await CargarReporte();
    }

    private async Task CargarReporte()
    {
        Cargando = true;
        Reporte = await ServicioControlador.ObtenerReporteAnualAsync(_anioSeleccionado);
        Cargando = false;

        await InvokeAsync(StateHasChanged);
    }

    private void VolverAFacturas()
    {
        Navigation.NavigateTo("/Vista");
    }
}